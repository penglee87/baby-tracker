# 开发文档

## 目录结构
```
miniprogram/
├── components/             # 通用组件
├── images/                 # 图片资源
├── pages/                  # 页面目录
│   ├── index/              # 首页
│   ├── tracker/            # 记录页 (核心功能)
│   ├── stats/              # 统计页
│   ├── profile/            # 个人中心/宝宝管理
│   └── growth/             # 成长记录
├── utils/                  # 工具函数
│   ├── util.ts             # 基础工具
│   └── storage.ts          # 数据存储/云开发核心逻辑
├── app.ts                  # 小程序入口
├── app.json                # 全局配置
└── app.wxss                # 全局样式
```

## 云开发数据库配置 (Cloud Database)

为了确保多人共享功能的正常使用，请在微信开发者工具 -> 云开发 -> 数据库 中创建以下集合，并设置权限。

### 集合列表 (Collections)

| 集合名称 | 用途 | 权限设置 (必须) | 说明 |
| :--- | :--- | :--- | :--- |
| **`babies`** | 存储宝宝基本信息 (头像、昵称、生日等) | **所有用户可读写** | 邀请加入时需读取，成员需编辑 |
| **`invitations`** | 存储临时邀请码 | **所有用户可读写** | 生成邀请码及验证邀请码 |
| **`join_requests`** | 存储家庭成员关系及加入记录 | **所有用户可读写** | 核心！成员加入、列表展示必须此权限 |
| **`events`** | 存储日常记录 (喂奶、睡眠等) | **所有用户可读写** | 所有家庭成员均可记录和查看 |
| **`growth`** | 存储成长记录 (身高、体重) | **所有用户可读写** | 所有家庭成员均可记录和查看 |
| **`milestones`** | 存储里程碑 (大事记) | **所有用户可读写** | 所有家庭成员均可记录和查看 |

### 权限设置操作路径
1. 打开微信开发者工具，点击工具栏的 **“云开发”** 按钮。
2. 进入 **“数据库”** 标签页。
3. 点击左侧 **“+”** 号，逐个创建上述集合。
4. 点击集合名称旁的 **“权限设置”** 标签。
5. 选择 **“所有用户可读写”** (自定义安全规则中通常对应 `{"read": true, "write": true}`)。

> **注意**：如果不设置为“所有用户可读写”，会导致被邀请人无法加入家庭、无法查看宝宝信息或无法看到其他成员等问题。

## 核心逻辑说明
- **在线优先策略**: 应用默认优先连接云数据库，确保多端数据一致。
- **本地缓存**: 用于加速首屏展示 (`listBabies` 等会优先读本地，再异步同步云端)。
- **邀请机制**: 
  - 创建者生成 6 位数字邀请码 (存入 `invitations`)。
  - 被邀请人输入码验证通过后，直接在 `join_requests` 插入记录。
  - 所有家庭成员通过查询 `join_requests` 聚合显示。

## 常见问题
- **Q: 为什么看不到其他家庭成员？**
  - A: 请检查 `join_requests` 集合权限是否为“所有用户可读写”。
- **Q: 为什么加入失败？**
  - A: 邀请码可能已过期（30分钟有效），或 `invitations` 集合权限不足。
